AWSTemplateFormatVersion: 2010-09-09
Description: WAFR Compliant CloudTrail with secure KMS encryption
Parameters:
  # WAFR SEC 08: Parameter for key administrators
  KeyAdministrators:
    Type: CommaDelimitedList
    Description: List of IAM user ARNs who can administer the KMS key
    Default: ""
  
  # WAFR COST 02: Lifecycle management parameter
  LogRetentionDays:
    Type: Number
    Description: CloudWatch logs retention period in days
    Default: 90
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
    
Conditions:
  HasKeyAdministrators: !Not [!Equals [!Join ["", !Ref KeyAdministrators], ""]]
  
Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: "BucketOwnerFullControl"
      BucketName: !Join
        - "-"
        - - "wafr-compliant-ct-s3"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - "/"
                  - !Ref "AWS::StackId"
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      # WAFR SEC 08: S3 bucket encryption
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      # WAFR COST 02: Lifecycle policy for cost optimization
      LifecycleConfiguration:
        Rules:
          - Id: CloudTrailLogTransition
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 90
                StorageClass: GLACIER
              - TransitionInDays: 365
                StorageClass: DEEP_ARCHIVE
            ExpirationInDays: 2555  # 7 years retention
      LoggingConfiguration:
        DestinationBucketName: !Ref LoggingBucket
        LogFilePrefix: s3-access-logs/
      # WAFR OPS 07: S3 notifications for monitoring
      NotificationConfiguration:
        CloudWatchConfigurations:
          - Event: s3:ObjectCreated:*
            CloudWatchConfiguration:
              LogGroupName: !Ref CloudTrailLogGroup
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-08-Encryption-LifeCycle"
          
  LoggingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        !Join [
          "-",
          [
            "wafr-compliant-logging-bucket",
            !Select [2, !Split ["/", !Ref AWS::StackId]],
          ],
        ]
      # WAFR SEC 08: Encryption for logging bucket
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-08-Logging-Encryption"
          
  S3BucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action:
              - "s3:GetBucketAcl"
            Resource: !Sub "arn:aws:s3:::${S3Bucket}"
            Condition:
              StringEquals:
                "AWS:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${AWS::StackName}-cloudtrail"
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action:
              - "s3:PutObject"
            Resource: !Sub "arn:aws:s3:::${S3Bucket}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
                "AWS:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${AWS::StackName}-cloudtrail"
          # WAFR SEC 08: Deny unencrypted uploads
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${S3Bucket}/*"
              - !Sub "arn:aws:s3:::${S3Bucket}"
            Condition:
              Bool:
                "aws:SecureTransport": "false"
                
  # WAFR SEC 08: Restricted KMS Key Policy (replaces lines 67-76)
  # AWS Documentation: https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html
  WartestkmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: WAFR Compliant KMS Key for CloudTrail encryption
      KeyUsage: ENCRYPT_DECRYPT
      KeySpec: SYMMETRIC_DEFAULT
      # WAFR COST 02: Automatic key rotation for compliance
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          # Root account permissions (required)
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
            
          # Key administrators (if specified)
          - !If
            - HasKeyAdministrators
            - Sid: Allow key administrators
              Effect: Allow
              Principal:
                AWS: !Ref KeyAdministrators
              Action:
                - "kms:Create*"
                - "kms:Describe*"
                - "kms:Enable*"
                - "kms:List*"
                - "kms:Put*"
                - "kms:Update*"
                - "kms:Revoke*"
                - "kms:Disable*"
                - "kms:Get*"
                - "kms:Delete*"
                - "kms:TagResource"
                - "kms:UntagResource"
                - "kms:ScheduleKeyDeletion"
                - "kms:CancelKeyDeletion"
              Resource: "*"
            - !Ref "AWS::NoValue"
            
          # CloudTrail service permissions (specific, not wildcard)
          - Sid: Allow CloudTrail to encrypt logs
            Effect: Allow
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              StringEquals:
                "kms:ViaService": !Sub "s3.${AWS::Region}.amazonaws.com"
                "AWS:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/*"
                
          # CloudWatch Logs permissions for log encryption
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              ArnEquals:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${AWS::StackName}-cloudtrail-logs"
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-08-Restricted-KMS-Policy"
        - Key: "Purpose"
          Value: "CloudTrail-Encryption"
          
  # WAFR SEC 08: KMS Key Alias for better management
  WartestkmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-cloudtrail-key"
      TargetKeyId: !Ref WartestkmsKey

  WARTestTrail:
    DependsOn:
      - S3BucketPolicy
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: !Sub "${AWS::StackName}-cloudtrail"
      S3BucketName: !Ref S3Bucket
      EnableLogFileValidation: true
      KMSKeyId: !GetAtt WartestkmsKey.Arn
      # WAFR OPS 07: Enhanced event selection for better monitoring
      AdvancedEventSelectors:
        - Name: "Management events selector"
          FieldSelectors:
            - Field: "eventCategory"
              Equals:
                - "Management"
        # WAFR SEC 04: Data events for sensitive resources
        - Name: "S3 data events selector"
          FieldSelectors:
            - Field: "eventCategory"
              Equals:
                - "Data"
            - Field: "resources.type"
              Equals:
                - "AWS::S3::Object"
            - Field: "resources.ARN"
              StartsWith:
                - !Sub "${S3Bucket}/*"
      IsLogging: true
      IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      # WAFR OPS 07: CloudWatch integration for monitoring
      CloudWatchLogsLogGroupArn: !Sub "${CloudTrailLogGroup.Arn}:*"
      CloudWatchLogsRoleArn: !GetAtt CloudTrailCloudWatchLogsRole.Arn
      # WAFR REL 08: Event data store integration
      InsightSelectors:
        - InsightType: ApiCallRateInsight
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-04-SEC-08-OPS-07"

  CloudTrailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${AWS::StackName}-cloudtrail-logs"
      # WAFR COST 02: Configurable retention for cost management
      RetentionInDays: !Ref LogRetentionDays
      # WAFR SEC 08: Encrypt CloudWatch logs
      KmsKeyId: !GetAtt WartestkmsKey.Arn
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-08-Log-Encryption"

  CloudTrailCloudWatchLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-CloudTrail-CloudWatchLogs-Role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                "aws:SourceArn": !Sub "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${AWS::StackName}-cloudtrail"
      Policies:
        - PolicyName: CloudTrailCloudWatchLogsPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:PutLogEvents
                  - logs:CreateLogStream
                Resource: !Sub "${CloudTrailLogGroup.Arn}:*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${S3Bucket}/*"
                  - !Sub "arn:aws:s3:::${S3Bucket}"
              # WAFR SEC 08: Specific KMS permissions
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Resource: !GetAtt WartestkmsKey.Arn
                Condition:
                  StringEquals:
                    "kms:ViaService": !Sub "s3.${AWS::Region}.amazonaws.com"
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-03-Least-Privilege"

  # WAFR OPS 07: SNS Topic with encryption
  AlarmTopic:
    Type: "AWS::SNS::Topic"
    Properties:
      TopicName: !Sub "${AWS::StackName}-cloudtrail-alarms"
      # WAFR SEC 08: SNS topic encryption
      KmsMasterKeyId: !Ref WartestkmsKey
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-08-SNS-Encryption"

  MyLambdaFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      FunctionName: !Sub "${AWS::StackName}-cloudtrail-processor"
      Handler: "index.handler"
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: "nodejs18.x"
      Timeout: 60
      # WAFR SEC 08: Environment variables encryption
      KmsKeyArn: !GetAtt WartestkmsKey.Arn
      # WAFR REL 08: Improved error handling
      Code:
        ZipFile: |
          const AWS = require('aws-sdk');
          
          exports.handler = async (event) => {
              console.log('Processing CloudTrail event:', JSON.stringify(event, null, 2));
              
              try {
                  // Process CloudTrail logs
                  const records = event.Records || [];
                  
                  for (const record of records) {
                      if (record.eventSource === 'aws:sns') {
                          const message = JSON.parse(record.Sns.Message);
                          console.log('Processing SNS message:', message);
                          
                          // Add custom processing logic here
                          // For example: security analysis, compliance checks, etc.
                      }
                  }
                  
                  return {
                      statusCode: 200,
                      body: JSON.stringify({
                          message: 'CloudTrail logs processed successfully',
                          processedRecords: records.length
                      })
                  };
              } catch (error) {
                  console.error('Error processing CloudTrail logs:', error);
                  
                  return {
                      statusCode: 500,
                      body: JSON.stringify({
                          error: 'Failed to process CloudTrail logs',
                          message: error.message
                      })
                  };
              }
          };
      # WAFR PERF 04: Environment variables for configuration
      Environment:
        Variables:
          LOG_LEVEL: INFO
          KMS_KEY_ID: !Ref WartestkmsKey
      Tags:
        - Key: "WAFR-Compliance"
          Value: "REL-08-SEC-08"

  LambdaExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Sub "${AWS::StackName}-Lambda-ExecutionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "lambda.amazonaws.com"
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: "CloudTrailLambdaPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # WAFR SEC 03: Specific permissions only
              - Effect: "Allow"
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${AWS::StackName}-*"
              - Effect: "Allow"
                Action: "sns:Publish"
                Resource: !Ref AlarmTopic
              # WAFR SEC 08: KMS permissions for decryption
              - Effect: "Allow"
                Action:
                  - "kms:Decrypt"
                  - "kms:DescribeKey"
                Resource: !GetAtt WartestkmsKey.Arn
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-03-Specific-Permissions"

  MySNSSubscription:
    Type: "AWS::SNS::Subscription"
    Properties:
      TopicArn: !Ref AlarmTopic
      Protocol: "lambda"
      Endpoint: !GetAtt MyLambdaFunction.Arn

  LambdaInvokePermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref MyLambdaFunction
      Principal: "sns.amazonaws.com"
      SourceArn: !Ref AlarmTopic

  # WAFR OPS 07: CloudWatch Alarms for monitoring
  UnauthorizedAPICallsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-UnauthorizedAPICalls"
      AlarmDescription: "Monitor for unauthorized API calls"
      MetricName: ErrorCount
      Namespace: CloudWatchLogs
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref AlarmTopic
      Tags:
        - Key: "WAFR-Compliance"
          Value: "OPS-07-Security-Monitoring"

  MyLambdaDeleteS3ExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Join
        - "-"
        - - "wafr-compliant-s3-cleanup-role"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - "/"
                  - !Ref "AWS::StackId"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      # WAFR SEC 03: Specific S3 permissions instead of full access
      Policies:
        - PolicyName: "S3CleanupPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "s3:DeleteObject"
                  - "s3:DeleteObjectVersion"
                  - "s3:ListBucket"
                  - "s3:ListBucketVersions"
                Resource:
                  - !Sub "arn:aws:s3:::${S3Bucket}"
                  - !Sub "arn:aws:s3:::${S3Bucket}/*"
              - Effect: "Allow"
                Action:
                  - "s3:DeleteBucket"
                Resource: !Sub "arn:aws:s3:::${S3Bucket}"
                Condition:
                  StringEquals:
                    "s3:ExistingBucketPolicy": "true"
      Tags:
        - Key: "WAFR-Compliance"
          Value: "SEC-03-Cleanup-Permissions"

  DeleteS3LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-s3-cleanup"
      Timeout: 120
      Runtime: python3.11
      Handler: "index.handler"
      Environment:
        Variables:
          Account: !Ref AWS::AccountId
          S3BucketName: !Ref S3Bucket
          LOG_LEVEL: INFO
      Role: !GetAtt MyLambdaDeleteS3ExecutionRole.Arn
      # WAFR REL 08: Enhanced error handling and logging
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import os
          import logging
          
          logger = logging.getLogger()
          logger.setLevel(os.environ.get('LOG_LEVEL', 'INFO'))
          
          def handler(event, context):
              responseData = {}
              
              try:
                  logger.info(f"Processing event: {event['RequestType']}")
                  
                  if event["RequestType"] == "Delete":
                      s3 = boto3.resource('s3')
                      bucket_name = os.environ['S3BucketName']
                      account = os.environ['Account']
                      
                      logger.info(f"Cleaning up S3 bucket: {bucket_name}")
                      
                      bucket = s3.Bucket(bucket_name)
                      
                      # Delete all objects
                      bucket.objects.all().delete()
                      logger.info("All objects deleted")
                      
                      # Delete all object versions
                      bucket.object_versions.all().delete()
                      logger.info("All object versions deleted")
                      
                      # Delete the bucket
                      bucket.delete(ExpectedBucketOwner=account)
                      logger.info(f"Bucket {bucket_name} deleted successfully")
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
                  else:
                      logger.info("No action required for Create/Update")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
                      
              except Exception as e:
                  logger.error(f"Error during cleanup: {str(e)}")
                  # Still send success to prevent stack rollback issues
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
      # WAFR SEC 08: Function encryption
      KmsKeyArn: !GetAtt WartestkmsKey.Arn
      Tags:
        - Key: "WAFR-Compliance"
          Value: "REL-08-Cleanup-Function"

  DeleteS3CustomResource:
    Type: Custom::DeleteS3
    Properties:
      ServiceToken: !GetAtt DeleteS3LambdaFunction.Arn
      ServiceTimeout: 120
      
Outputs:
  WARTestTrailId:
    Description: CloudTrail ID
    Value: !Ref WARTestTrail
    Export:
      Name: !Sub "${AWS::StackName}-CloudTrail"
  WARTestTrailArn:
    Description: CloudTrail Arn
    Value: !GetAtt "WARTestTrail.Arn"
  S3BucketName:
    Description: S3 Bucket Name
    Value: !Ref S3Bucket
    Export:
      Name: !Sub "${AWS::StackName}-S3Bucket"
  S3BucketArn:
    Description: S3 Bucket Arn
    Value: !GetAtt "S3Bucket.Arn"
  KMSKeyId:
    Description: KMS Key ID for CloudTrail encryption
    Value: !Ref WartestkmsKey
    Export:
      Name: !Sub "${AWS::StackName}-KMSKey"
  KMSKeyArn:
    Description: KMS Key ARN for CloudTrail encryption
    Value: !GetAtt WartestkmsKey.Arn
  AccountIdRegion:
    Description: AccountIdRegion
    Value: !Join ["", [!Ref AWS::AccountId, "/", !Ref AWS::Region]]
  CloudTrailLogGroupName:
    Description: CloudTrail log group
    Value: !Ref CloudTrailLogGroup
    Export:
      Name: !Sub "${AWS::StackName}-LogGroup"
  AlarmTopicID:
    Description: Alarm Topic ID
    Value: !Ref AlarmTopic
    Export:
      Name: !Sub "${AWS::StackName}-AlarmTopic"
  WAFRComplianceStatus:
    Description: WAFR Compliance Implementation Status
    Value: "SEC-03,SEC-04,SEC-08,REL-08,COST-02,OPS-07,PERF-04 - Implemented"
