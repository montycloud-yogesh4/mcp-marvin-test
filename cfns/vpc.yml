AWSTemplateFormatVersion: "2010-09-09"
Description: Create a VPC with Subnets, Internet Gateway and Security Groups - WAFR Compliant
Mappings:
  AMIMap:
    us-east-1:
      AMI: ami-0aa7d40eeae50c9a9
    us-east-2:
      AMI: ami-05bfbece1ed5beb54
Parameters:
  # WAFR REMEDIATION (SEC-3): Added parameter for admin access restriction
  AdminCidrBlock:
    Description: CIDR block for administrative access (should be your organization's public IP range)
    Type: String
    Default: "10.0.0.0/8"
    AllowedPattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$
    ConstraintDescription: Must be a valid IP CIDR range
Resources:
  # WAFR REMEDIATION (SEC-2): Implemented least privilege IAM role for Lambda
  # AWS Well-Architected Security Pillar - Question SEC-2: How do you control access to people and systems?
  # Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege
  DefaultVPCNCRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: "VPCDescribeOnlyPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # WAFR FIX: Restricted EC2 permissions to only required operations
              - Effect: Allow
                Action:
                  - ec2:DescribeVpcs
                  - ec2:DescribeSubnets
                Resource: "*"
              # WAFR REMEDIATION: Specific CloudWatch Logs permissions
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:CreateLogGroup
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"
          
  DefaultVPCNCLambda:
    Type: AWS::Lambda::Function
    Properties:
      Role: !Sub ${DefaultVPCNCRole.Arn}
      Handler: index.handler
      # WAFR REMEDIATION (REL-4): Appropriate timeout for function complexity
      Timeout: 300
      Runtime: python3.12
      # WAFR REMEDIATION (OPS-11): Disabled X-Ray tracing or set to Active for monitoring
      TracingConfig:
        Mode: Active
      # WAFR REMEDIATION (PERF-2): Optimized memory allocation
      MemorySize: 256
      Code:
        ZipFile: !Sub |
          import json
          import os
          import boto3
          import cfnresponse
          import logging
          
          # WAFR REMEDIATION (OPS-7): Added proper logging
          logger = logging.getLogger()
          logger.setLevel(logging.INFO)
          
          def handler(event, context):
              try:
                  logger.info(f"Processing event: {event.get('RequestType', 'Unknown')}")
                  
                  if event["RequestType"] == "Create":
                      ec2 = boto3.client('ec2')
                      default_vpc = ec2.describe_vpcs(Filters=[{'Name':'isDefault', 'Values':['true']}])
                      
                      if not default_vpc["Vpcs"]:
                          logger.error("No default VPC found")
                          raise Exception("No default VPC found")
                          
                      defaultvpc = default_vpc["Vpcs"][0]["VpcId"]
                      logger.info(f"Found default VPC: {defaultvpc}")
                      
                      subnets = ec2.describe_subnets(Filters=[{'Name': 'vpc-id', 'Values': [defaultvpc]}])
                      
                      if not subnets['Subnets']:
                          logger.error("No subnets found in default VPC")
                          raise Exception("No subnets found in default VPC")
                          
                      subnet_ids = [subnet['SubnetId'] for subnet in subnets['Subnets']]
                      subnet_id = subnet_ids[0]
                      logger.info(f"Using subnet: {subnet_id}")
                      
                      responseData = {"defaultvpc": defaultvpc, "subnetid": subnet_id}
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
                      return responseData
                      
                  elif event["RequestType"] in ["Update", "Delete"]:
                      logger.info(f"Processing {event['RequestType']} request")
                      responseData = {}
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
                      return responseData
                      
              except Exception as e:
                  logger.error(f"Error in Lambda function: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {}, str(e))
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"
          
  DefaultVPCCR:
    Type: Custom::DefaultVPCCR
    Properties:
      ServiceToken: !Sub ${DefaultVPCNCLambda.Arn}
      
  # WAFR REMEDIATION (REL-9): Enhanced VPC with better CIDR and DNS configuration
  # AWS Well-Architected Reliability Pillar - Question REL-9: How do you plan your network topology?
  # Reference: https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      # WAFR REMEDIATION: Using standard private IP range
      CidrBlock: 10.0.0.0/16
      InstanceTenancy: default
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: MC_KEY
          Value: WARNCVPC1
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-vpc"
          
  # WAFR REMEDIATION (REL-10): Multi-AZ subnet deployment for high availability
  SubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.0.1.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: AWS::Region
      # WAFR REMEDIATION (SEC-3): Disabled auto-assign public IP for security
      MapPublicIpOnLaunch: false
      Tags:
        - Key: MC_KEY
          Value: WARNCSUBNET1
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-subnet-a"
        - Key: Type
          Value: "Private"
          
  SubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.0.2.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 1
        - !GetAZs
          Ref: AWS::Region
      # WAFR REMEDIATION (SEC-3): Disabled auto-assign public IP for security
      MapPublicIpOnLaunch: false
      Tags:
        - Key: MC_KEY
          Value: WARNCSUBNET2
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-subnet-b"
        - Key: Type
          Value: "Private"
          
  SubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.0.3.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 2
        - !GetAZs
          Ref: AWS::Region
      # WAFR REMEDIATION (SEC-3): Disabled auto-assign public IP for security
      MapPublicIpOnLaunch: false
      Tags:
        - Key: MC_KEY
          Value: WARNCSUBNET3
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-subnet-c"
        - Key: Type
          Value: "Private"
          
  # WAFR REMEDIATION: Added public subnets for proper architecture
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.0.101.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: AWS::Region
      MapPublicIpOnLaunch: true
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-subnet-a"
        - Key: Type
          Value: "Public"
          
  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.0.102.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 1
        - !GetAZs
          Ref: AWS::Region
      MapPublicIpOnLaunch: true
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-subnet-b"
        - Key: Type
          Value: "Public"
          
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: MC_KEY
          Value: WARNCIG1
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-igw"
          
  VPCGatewayAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
      
  # WAFR REMEDIATION: Separate route tables for public and private subnets
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-rt"
          
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: MC_KEY
          Value: WARNCROUTE1
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-rt"
          
  PublicInternetRoute:
    Type: "AWS::EC2::Route"
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref PublicRouteTable
      
  # Route table associations for public subnets
  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable
      
  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable
      
  # Route table associations for private subnets (NAT Gateway routes would be added here)
  SubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetA
      RouteTableId: !Ref PrivateRouteTable
      
  SubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetB
      RouteTableId: !Ref PrivateRouteTable
      
  SubnetCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetC
      RouteTableId: !Ref PrivateRouteTable
      
  # WAFR REMEDIATION (SEC-3): Implemented least privilege security groups
  # AWS Well-Architected Security Pillar - Question SEC-3: How do you control traffic at all layers?
  # Reference: https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#SecurityGroupRules
  
  # WAFR FIX: Replaced overly permissive security group with specific rules
  WebTierSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "WAFR-compliant security group for web tier - allows only necessary traffic"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # WAFR FIX: Only allow HTTP/HTTPS from load balancer, not from 0.0.0.0/0
        - IpProtocol: "tcp"
          FromPort: "80"
          ToPort: "80"
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
          Description: "HTTP from load balancer only"
        - IpProtocol: "tcp"
          FromPort: "443"
          ToPort: "443"
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
          Description: "HTTPS from load balancer only"
      SecurityGroupEgress:
        # WAFR REMEDIATION: Specific egress rules for better security
        - IpProtocol: "tcp"
          FromPort: "443"
          ToPort: "443"
          CidrIp: "0.0.0.0/0"
          Description: "HTTPS outbound for API calls and updates"
        - IpProtocol: "tcp"
          FromPort: "80"
          ToPort: "80"
          CidrIp: "0.0.0.0/0"
          Description: "HTTP outbound for package updates"
      Tags:
        - Key: MC_KEY
          Value: WARNCSG1
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-web-tier-sg"
          
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "WAFR-compliant load balancer security group"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: "tcp"
          FromPort: "80"
          ToPort: "80"
          CidrIp: "0.0.0.0/0"
          Description: "HTTP from internet"
        - IpProtocol: "tcp"
          FromPort: "443"
          ToPort: "443"
          CidrIp: "0.0.0.0/0"
          Description: "HTTPS from internet"
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-alb-sg"
          
  # WAFR REMEDIATION (SEC-3): Replaced overly permissive SecurityGroup2 with admin access SG
  AdminAccessSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "WAFR-compliant administrative access - restricted to organization IPs"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # WAFR FIX: SSH access restricted to admin CIDR block instead of 0.0.0.0/0
        - IpProtocol: "tcp"
          FromPort: "22"
          ToPort: "22"
          CidrIp: !Ref AdminCidrBlock
          Description: "SSH access from admin networks only"
        # WAFR FIX: RDP access restricted to admin CIDR block instead of 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref AdminCidrBlock
          Description: "RDP access from admin networks only"
      SecurityGroupEgress:
        # WAFR REMEDIATION: Specific outbound rules
        - IpProtocol: "tcp"
          FromPort: "443"
          ToPort: "443"
          CidrIp: "0.0.0.0/0"
          Description: "HTTPS outbound"
        - IpProtocol: "tcp"
          FromPort: "80"
          ToPort: "80"
          CidrIp: "0.0.0.0/0"
          Description: "HTTP outbound"
      Tags:
        - Key: MC_KEY
          Value: WARNCSG2
        - Key: "WAFRCompliant"
          Value: "true"
        - Key: Name
          Value: !Sub "${AWS::StackName}-admin-sg"
          
  # WAFR REMEDIATION (SEC-2): Enhanced IAM role with least privilege
  MyLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "lambda.amazonaws.com"
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: "SecurityGroupCleanupPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # WAFR FIX: Scoped EC2 permissions to specific VPC and operations
              - Effect: "Allow"
                Action:
                  - "ec2:DescribeVpcs"
                  - "ec2:DescribeSecurityGroups"
                  - "ec2:DeleteSecurityGroup"
                  - "ec2:RevokeSecurityGroupIngress"
                Resource: 
                  - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VPC}"
                  - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*"
                Condition:
                  StringEquals:
                    "ec2:Region": !Ref "AWS::Region"
              # WAFR REMEDIATION: Scoped CloudWatch Logs permissions
              - Effect: "Allow"
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"

  # Enhanced Lambda Function with better error handling and logging
  DeleteEMRSecurityGroupsFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: "index.handler"
      Role: !GetAtt MyLambdaExecutionRole.Arn
      Environment:
        Variables:
          VPC_ID: !Ref VPC
          LOG_LEVEL: "INFO"
      Code:
        ZipFile: |
          import os
          import boto3
          import cfnresponse
          import logging
          
          # WAFR REMEDIATION (OPS-7): Enhanced logging
          logger = logging.getLogger()
          logger.setLevel(logging.INFO)
          
          def delete_security_groups(ec2_client):
              vpc_id = os.environ.get('VPC_ID')
              sg_names_to_delete = ['ElasticMapReduce-slave', 'ElasticMapReduce-master']
              
              logger.info(f"Starting security group cleanup for VPC: {vpc_id}")
              
              for sg_name in sg_names_to_delete:
                  try:
                      security_groups = ec2_client.describe_security_groups(
                          Filters=[
                              {'Name': 'group-name', 'Values': [sg_name]},
                              {'Name': 'vpc-id', 'Values': [vpc_id]}
                          ]
                      )['SecurityGroups']
                      
                      for sg in security_groups:
                          sg_id = sg['GroupId']
                          logger.info(f"Processing security group: {sg_id} ({sg_name})")
                          
                          # Remove inbound rules first
                          try:
                              response = ec2_client.describe_security_groups(GroupIds=[sg_id])
                              ip_permissions = response['SecurityGroups'][0]['IpPermissions']
                              
                              if ip_permissions:
                                  ec2_client.revoke_security_group_ingress(GroupId=sg_id, IpPermissions=ip_permissions)
                                  logger.info(f"Removed inbound rules for {sg_id}")
                              
                              # Delete the security group
                              ec2_client.delete_security_group(GroupId=sg_id)
                              logger.info(f"Deleted security group {sg_name} ({sg_id})")
                              
                          except Exception as e:
                              logger.warning(f"Could not process security group {sg_id}: {str(e)}")
                              
                  except Exception as e:
                      logger.warning(f"Could not find or process security group {sg_name}: {str(e)}")
          
          def handler(event, context):
              try:
                  logger.info(f"Processing event: {event.get('RequestType', 'Unknown')}")
                  ec2_client = boto3.client('ec2')          
                  
                  if event["RequestType"] == "Delete":
                      delete_security_groups(ec2_client)
                  
                  responseData = {}
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalIDEMRNC")
                  
              except Exception as e:
                  logger.error(f"Error in cleanup function: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {}, str(e))
      Runtime: python3.11
      Timeout: 300
      MemorySize: 256
      Tags:
        - Key: "WAFRCompliant"
          Value: "true"

  # Custom Resource to Trigger the Lambda Function
  DeleteSecurityGroupsCustomResource:
    Type: Custom::DeleteEMRSecurityGroups
    Properties:
      ServiceToken: !GetAtt DeleteEMRSecurityGroupsFunction.Arn
      ServiceTimeout: 300

Outputs:
  AccountIdRegion:
    Description: AccountIdRegion
    Value: !Join
      - ""
      - - !Ref AWS::AccountId
        - /
        - !Ref AWS::Region
        
  # WAFR REMEDIATION: Updated security group exports with WAFR-compliant groups
  WebTierSecurityGroupID:
    Description: WAFR-compliant Web Tier Security Group ID
    Value: !Ref WebTierSecurityGroup
    Export:
      Name: SecurityGroupID1
      
  AdminSecurityGroupID:
    Description: WAFR-compliant Admin Access Security Group ID
    Value: !Ref AdminAccessSecurityGroup
    Export:
      Name: SecurityGroupID2
      
  LoadBalancerSecurityGroupID:
    Description: Load Balancer Security Group ID
    Value: !Ref LoadBalancerSecurityGroup
    Export:
      Name: LoadBalancerSecurityGroupID
      
  VPCID:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: VPCID
      
  # WAFR REMEDIATION: Export private subnets (original behavior)
  SubnetAID:
    Description: Private Subnet A ID
    Value: !Ref SubnetA
    Export:
      Name: SubnetAID
      
  SubnetBID:
    Description: Private Subnet B ID
    Value: !Ref SubnetB
    Export:
      Name: SubnetBID
      
  SubnetCID:
    Description: Private Subnet C ID
    Value: !Ref SubnetC
    Export:
      Name: SubnetCID
      
  # WAFR REMEDIATION: Added public subnet exports
  PublicSubnetAID:
    Description: Public Subnet A ID
    Value: !Ref PublicSubnetA
    Export:
      Name: PublicSubnetAID
      
  PublicSubnetBID:
    Description: Public Subnet B ID
    Value: !Ref PublicSubnetB
    Export:
      Name: PublicSubnetBID
      
  InternetGatewayID:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway
    Export:
      Name: InternetGatewayID
      
  PublicRouteTableID:
    Description: Public Route Table ID
    Value: !Ref PublicRouteTable
    Export:
      Name: PublicRouteTableID
      
  PrivateRouteTableID:
    Description: Private Route Table ID
    Value: !Ref PrivateRouteTable
    Export:
      Name: RouteTableID
      
  DefaultVPCId:
    Description: ID of the Default VPC
    Value: !GetAtt DefaultVPCCR.defaultvpc
    
  SubnetID:
    Description: Default VPC Subnet ID
    Value: !GetAtt DefaultVPCCR.subnetid
