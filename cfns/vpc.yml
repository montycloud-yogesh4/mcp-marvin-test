AWSTemplateFormatVersion: "2010-09-09"
Description: Create a VPC with Subnets, Internet Gateway and Security Groups - WAFR Remediated
Mappings:
  AMIMap:
    us-east-1:
      AMI: ami-0aa7d40eeae50c9a9
    us-east-2:
      AMI: ami-05bfbece1ed5beb54
Parameters:
  # WAFR SEC 5: Add parameter for trusted IP ranges
  TrustedCIDR:
    Type: String
    Default: "10.0.0.0/16"
    Description: CIDR block for trusted network access
    AllowedPattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$
Resources:
  # WAFR SEC 8: Add KMS Key for encryption
  VPCKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS Key for VPC Lambda function encryption
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Sid: Allow Lambda service
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Decrypt"
              - "kms:DescribeKey"
            Resource: "*"
  
  VPCKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/vpc-lambda-encryption
      TargetKeyId: !Ref VPCKMSKey
      
  DefaultVPCNCRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: VPCLambdaMinimalPolicy  # WAFR SEC 3: Renamed for clarity
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # WAFR SEC 3: Least privilege - specific EC2 actions only
              - Effect: Allow
                Action:
                  - "ec2:DescribeVpcs"
                  - "ec2:DescribeSubnets"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:DescribeLogGroups"
                  - "logs:CreateLogGroup"
                  - "logs:PutLogEvents"
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/DefaultVPCNC*"
              # WAFR SEC 8: KMS permissions for encryption
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                  - "kms:DescribeKey"
                Resource: !GetAtt VPCKMSKey.Arn
  
  DefaultVPCNCLambda:
    Type: AWS::Lambda::Function
    Properties:
      Role: !Sub ${DefaultVPCNCRole.Arn}
      Handler: index.handler
      Timeout: 600
      Runtime: python3.12
      # WAFR SEC 4: Enable active tracing for monitoring
      TracingConfig:
        Mode: Active
      # WAFR SEC 8: Add KMS encryption for environment variables
      KmsKeyArn: !GetAtt VPCKMSKey.Arn
      # WAFR REL 6: Add dead letter queue configuration
      DeadLetterConfig:
        TargetArn: !GetAtt DefaultVPCDLQ.Arn
      Code:
        ZipFile: !Sub |
          import json
          import os
          import boto3
          import cfnresponse
          def handler(event, context):
              print(event)
              if event["RequestType"] == "Create":
                  ec2 = boto3.client('ec2')
                  default_vpc = ec2.describe_vpcs(Filters=[{'Name':'isDefault', 'Values':['true']}])
                  print(default_vpc)
                  defaultvpc=default_vpc["Vpcs"][0]["VpcId"]
                  print(defaultvpc)
                  subnets = ec2.describe_subnets(Filters=[{'Name': 'vpc-id', 'Values': [defaultvpc]}])
                  subnet_ids = [subnet['SubnetId'] for subnet in subnets['Subnets']]
                  subnet_id=subnet_ids[0]
                  print(subnet_id)
                  responseData = {"defaultvpc": defaultvpc,"subnetid": subnet_id}
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
                  return responseData
              elif (event["RequestType"] == "Update" or event["RequestType"] == "Delete"):
                  print("Update or delete Create Logic")
                  responseData = {}
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalID")
                  return responseData
  
  # WAFR REL 6: Add SQS Dead Letter Queue for Lambda error handling
  DefaultVPCDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: DefaultVPCLambda-DLQ
      MessageRetentionPeriod: 1209600  # 14 days
      KmsMasterKeyId: !Ref VPCKMSKey
  
  # WAFR REL 6: Add CloudWatch Alarms for monitoring
  DefaultVPCLambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: DefaultVPCLambda-Errors
      AlarmDescription: Monitor Lambda function errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref DefaultVPCNCLambda
          
  DefaultVPCCR:
    Type: Custom::DefaultVPCCR
    Properties:
      ServiceToken: !Sub ${DefaultVPCNCLambda.Arn}
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 198.16.0.0/16
      InstanceTenancy: default
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: MC_KEY
          Value: WARNCVPC1
  SubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 198.16.1.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: AWS::Region
      MapPublicIpOnLaunch: true
      Tags:
        - Key: MC_KEY
          Value: WARNCSUBNET1
  SubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 198.16.2.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 1
        - !GetAZs
          Ref: AWS::Region
      MapPublicIpOnLaunch: true
      Tags:
        - Key: MC_KEY
          Value: WARNCSUBNET2
  SubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 198.16.3.0/24
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 2
        - !GetAZs
          Ref: AWS::Region
      MapPublicIpOnLaunch: true
      Tags:
        - Key: MC_KEY
          Value: WARNCSUBNET3
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: MC_KEY
          Value: WARNCIG1
  VPCGatewayAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: MC_KEY
          Value: WARNCROUTE1
  InternetRoute:
    Type: "AWS::EC2::Route"
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref RouteTable
  SubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetA
      RouteTableId: !Ref RouteTable
  SubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetB
      RouteTableId: !Ref RouteTable
      
  # WAFR SEC 5: CRITICAL FIX - Replace overly permissive security group
  SecurityGroup1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Secure access with restricted ingress rules - WAFR Compliant
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # WAFR SEC 5: Replace "-1" (all protocols) with specific HTTP/HTTPS rules
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref TrustedCIDR  # WAFR SEC 5: Use parameter instead of 0.0.0.0/0
          Description: HTTP access from trusted networks
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref TrustedCIDR  # WAFR SEC 5: Use parameter instead of 0.0.0.0/0
          Description: HTTPS access from trusted networks
      SecurityGroupEgress:
        # WAFR SEC 5: Add explicit egress rules
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP outbound
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound
      Tags:
        - Key: MC_KEY
          Value: WARNCSG1
        - Key: WAFR-Compliant
          Value: "true"
          
  # WAFR SEC 5: Improved Security Group 2 with proper restrictions
  SecurityGroup2:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Administrative access with WAFR compliance
      SecurityGroupIngress:
        # WAFR SEC 5: SSH access restricted to trusted networks
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref TrustedCIDR  # WAFR SEC 5: Remove 0.0.0.0/0
          Description: SSH access from trusted networks only
        # WAFR SEC 5: RDP access restricted to trusted networks  
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref TrustedCIDR  # WAFR SEC 5: Remove 0.0.0.0/0
          Description: RDP access from trusted networks only
      SecurityGroupEgress:
        - IpProtocol: "-1"
          FromPort: 0
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
      Tags:
        - Key: MC_KEY
          Value: WARNCSG2
        - Key: WAFR-Compliant
          Value: "true"
          
  # The below Lambda function delete the security groups created as part of the cluster.
  MyLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "lambda.amazonaws.com"
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: "LambdaEC2Permissions"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "ec2:DescribeVpcs"
                  - "ec2:DescribeSecurityGroups"
                  - "ec2:DeleteSecurityGroup"
                  - "ec2:RevokeSecurityGroupIngress"
                  - "logs:*"
                Resource: "*"

  # Lambda Function
  DeleteEMRSecurityGroupsFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: "index.handler"
      Role: !GetAtt MyLambdaExecutionRole.Arn
      Environment:
        Variables:
          VPC_ID: !Ref VPC
      Code:
        ZipFile: |
          import os
          import boto3
          import cfnresponse
          def delete_security_groups(ec2_client):
            # Security group names to delete
            sg_names_to_delete = ['ElasticMapReduce-slave', 'ElasticMapReduce-master']
            # Retrieve all VPCs
            vpc_id = os.environ.get('VPC_ID')
            # For each VPC, look for each security group name we want to delete
            for sg_name in sg_names_to_delete:
              security_groups = ec2_client.describe_security_groups(
                Filters=[
                  {'Name': 'group-name', 'Values': [sg_name]},
                  {'Name': 'vpc-id', 'Values': [vpc_id]}
                ]
              )['SecurityGroups']
              for sg in security_groups:
                sg_id = sg['GroupId']
                try:
                  response = ec2_client.describe_security_groups(GroupIds=[sg_id])
                  ip_permissions = response['SecurityGroups'][0]['IpPermissions']

                  # Revoke all inbound rules
                  if ip_permissions:
                      ec2_client.revoke_security_group_ingress(GroupId=sg_id, IpPermissions=ip_permissions)
                      print(f"Inbound rules removed for Security Group {sg_id}")
                  else:
                      print("No inbound rules to remove.")
                except Exception as e:
                  print(f"Could not remove inbound rules {sg_id}")
            for sg_name in sg_names_to_delete:
              security_groups = ec2_client.describe_security_groups(
                Filters=[
                  {'Name': 'group-name', 'Values': [sg_name]},
                  {'Name': 'vpc-id', 'Values': [vpc_id]}
                ]
              )['SecurityGroups']
              for sg in security_groups:
                sg_id = sg['GroupId']
                try:
                  ec2_client.delete_security_group(GroupId=sg_id)
                  print(f"Deleted security group {sg_name} ({sg_id}) in VPC {vpc_id}")
                except Exception as e:
                  print(f"Could not delete security group {sg_name} ({sg_id}) in VPC {vpc_id}: {str(e)}")


          def handler(event, context):
            ec2_client = boto3.client('ec2')          
            if (event["RequestType"] == "Delete"):
              delete_security_groups(ec2_client)
              responseData = {}
              cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalIDEMRNC")
              return
            elif (event["RequestType"] == "Create" or event["RequestType"] == "Update"):
              responseData = {}
              cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "CustomResourcePhysicalIDEMRNC")
              return
      Runtime: python3.11
      Timeout: 300
      MemorySize: 128

  # Custom Resource to Trigger the Lambda Function
  DeleteSecurityGroupsCustomResource:
    Type: Custom::DeleteEMRSecurityGroups
    Properties:
      ServiceToken: !GetAtt DeleteEMRSecurityGroupsFunction.Arn
      ServiceTimeout: 300

Outputs:
  AccountIdRegion:
    Description: AccountIdRegion
    Value: !Join
      - ""
      - - !Ref AWS::AccountId
        - /
        - !Ref AWS::Region
  SecurityGroupID1:
    Description: Security Group -1 ID
    Value: !Ref SecurityGroup1
    Export:
      Name: SecurityGroupID1
  SecurityGroupID2:
    Description: Security Group -2 ID
    Value: !Ref SecurityGroup2
    Export:
      Name: SecurityGroupID2
  VPCID:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: VPCID
  SubnetAID:
    Description: Subnet A ID
    Value: !Ref SubnetA
    Export:
      Name: SubnetAID
  SubnetBID:
    Description: Subnet B ID
    Value: !Ref SubnetB
    Export:
      Name: SubnetBID
  SubnetCID:
    Description: Subnet B ID
    Value: !Ref SubnetC
    Export:
      Name: SubnetCID
  InternetGatewayID:
    Description: Internetgateway ID
    Value: !Ref InternetGateway
    Export:
      Name: InternetGatewayID
  RouteTableID:
    Description: RouteTable ID
    Value: !Ref RouteTable
    Export:
      Name: RouteTableID
  DefaultVPCId:
    Description: ID of the Default VPCs
    Value: !GetAtt DefaultVPCCR.defaultvpc
  SubnetID:
    Description: Subnet ID
    Value: !GetAtt DefaultVPCCR.subnetid